# 하남교구 온라인 기도실 상세 기능 설명서

문서 버전: 1.0  
작성 기준: 현재 코드베이스 구현 상태

## 1. 문서 목적

이 문서는 하남교구 온라인 기도실 애플리케이션의 현재 구현을 기준으로, 기능 동작과 데이터 처리 방식을 상세히 설명한다.  
기획, 운영, 유지보수, 신규 개발 인수인계를 위한 기준 문서로 사용한다.

## 2. 시스템 개요

### 2.1 서비스 목표

- 성도들이 기도 제목을 온라인으로 작성하고 공유할 수 있다.
- 공개 기도 제목을 순차적으로 읽으며 함께 기도한 기록(카운트)을 남길 수 있다.
- 민감한 기도 제목은 `교역자만 보기`로 비공개 접수할 수 있다.

### 2.2 사용자 관점 핵심 흐름

1. 홈 화면에서 `중보 기도실 입장` 또는 `기도 제목 작성` 선택
2. 기도 제목 작성 시 이름/전화번호/내용/공개범위를 입력
3. 동일 조건의 기존 기도 제목이 있으면 유지/교체 선택
4. 공개 기도실에서 기도 제목을 순차 열람
5. 각 기도 제목에 `기도하기` 버튼으로 참여 표시

## 3. 기술 구성

### 3.1 프론트엔드

- React 18 + TypeScript + Vite
- UI 아이콘: `lucide-react`
- 스타일: Tailwind CDN + 커스텀 CSS (`index.html` 내 설정)

### 3.2 백엔드 연동

- Supabase JavaScript Client 사용
- 테이블: `public.prayers`
- 앱 레벨 라우팅 없이 단일 페이지 내부 모드 전환 방식 사용

## 4. 화면 및 기능 명세

## 4.1 공통 레이아웃 (`Layout`)

### 기능

- 모바일 우선 레이아웃 제공
- 상단 헤더에 제목 표시
- HOME이 아닌 모드에서 뒤로가기/홈 버튼 노출
- 하단 푸터 고정 출력: `오륜교회 하남교구 © 2026`

### 입력/출력

- 입력: `mode`, `title`, `children`, `onNavigate`
- 출력: 공통 프레임 + 자식 화면 렌더링

### 근거 코드

- `components/Layout.tsx`

## 4.2 홈 화면 (`HOME`)

### 기능

- 서비스 소개 문구와 2개 진입 액션 제공
- 액션 1: `중보 기도실 입장` 클릭 시 ROOM 모드 진입
- 액션 2: `기도 제목 작성` 클릭 시 WRITE 모드 진입
- 이용 안내 3종 표시
  - 전화번호 비공개 안내
  - 교역자만 보기 옵션 안내
  - 동일 이름/전화번호 재작성 시 수정 가능 안내

### 상태 전환

- `HOME -> ROOM`
- `HOME -> WRITE`

### 근거 코드

- `App.tsx`

## 4.3 기도 제목 작성 화면 (`WRITE`)

### 입력 필드

- 이름 (`name`)
- 전화번호 (`phone`)
- 기도 제목 내용 (`content`)
- 공개 범위 (`is_public`)
  - `true`: 전체 공개
  - `false`: 교역자만 보기

### 유효성 처리

- 이름/전화번호/내용 중 하나라도 비어 있으면 제출 차단
- 전화번호 입력 시 숫자만 추출 후 자동 하이픈 포맷 적용
  - 예: `01012345678 -> 010-1234-5678`

### 제출 처리

1. 중복 검사: `name + phone + is_public` 조건으로 조회
2. 중복 없음: 새 레코드 INSERT
3. 중복 있음: 충돌 해결 UI 진입

### 충돌 해결(중복 발생) 동작

- 기존 내용 유지(`KEEP_OLD`)
  - 기존 DB 값 유지
  - 성공 처리 후 HOME으로 이동
- 새 내용으로 교체(`REPLACE_NEW`)
  - 기존 레코드 `content`, `is_public`, `created_at`, `prayed_count` 갱신
  - `prayed_count`는 0으로 리셋

### 예외 처리

- Supabase 조회/저장/수정 실패 시 alert 메시지 노출
- 콘솔에 오류 로그 출력

### 근거 코드

- `components/PrayerForm.tsx`

## 4.4 중보 기도실 화면 (`ROOM`)

### 목록 로딩

- `is_public = true` 조건 데이터만 조회
- `created_at DESC` 정렬(최신순)

### 상태별 UI

- 로딩 중: 스피너 + 안내 문구
- 데이터 없음: 첫 기도 제목 작성 유도 버튼 표시
- 열람 완료: 다시 보기/작성하기 버튼 표시
- 열람 중: 현재 기도 카드 표시

### 열람 동작

- 현재 인덱스 기준 카드 1개씩 표시
- `다음 기도 보기` 클릭 시 다음 카드로 이동
- 진행률 표시: `N번째 / 총 M개`

### 함께 기도하기(`기도하기`) 동작

- 로컬 상태와 UI를 먼저 갱신하는 낙관적 업데이트 사용
- 현재 카드 기준 카운트 증감 및 버튼 상태 전환
- 브라우저 `localStorage`에 `prayed_{id}` 키 저장
- 이후 Supabase `prayed_count` 업데이트
- 실패 시 화면 상태는 롤백

### 근거 코드

- `components/PrayerRoom.tsx`

## 5. 애플리케이션 상태 모델

## 5.1 전역 모드

- `HOME`
- `WRITE`
- `ROOM`

모드 관리는 단일 `useState`로 처리되며 URL 라우팅은 사용하지 않는다.

## 5.2 ROOM 내부 상태

- `prayers`: 공개 기도 목록
- `currentIndex`: 현재 표시 카드 인덱스
- `isPrayed`: 현재 카드에 대한 사용자 기도 여부
- `isUpdatingPrayer`: 카운트 업데이트 중 중복 클릭 방지

## 6. 데이터 모델

### 6.1 prayers 테이블 스키마(코드 주석 기준)

| 필드 | 타입 | 설명 |
|---|---|---|
| id | bigint (PK) | 기도 제목 식별자 |
| created_at | timestamptz | 생성/갱신 시각 |
| name | text | 작성자 이름 |
| phone | text | 작성자 전화번호 |
| content | text | 기도 제목 본문 |
| is_public | boolean | 공개 여부 |
| prayed_count | integer | 함께 기도한 횟수 |

### 6.2 타입 정의

- 프론트엔드 타입 `Prayer`는 위 필드와 동일 구조를 반영한다.
- `id`, `created_at`, `prayed_count`는 선택 필드로 정의되어 있다.

근거 코드:

- `supabaseClient.ts`
- `types.ts`

## 7. Supabase 연동 상세

| 기능 | 테이블 연산 | 조건/페이로드 |
|---|---|---|
| 중복 검사 | `select(*)` | `name`, `phone`, `is_public` 일치 |
| 신규 등록 | `insert` | `name`, `phone`, `content`, `is_public` |
| 중복 교체 | `update` | `id` 기준으로 내용/공개여부/시각/카운트 수정 |
| 기도실 조회 | `select(*)` | `is_public = true`, 최신순 정렬 |
| 기도 카운트 | `update` | `id` 기준 `prayed_count` 반영 |

## 8. 사용자 피드백 정책

### 8.1 성공 피드백

- 등록 성공: `기도 제목이 성공적으로 전달되었습니다.`
- 중복 교체 성공: `새로운 기도 제목으로 변경되었습니다.`
- 기존 유지 선택: `기존 기도 제목을 유지합니다.`

### 8.2 실패 피드백

- 공통적으로 alert 기반 오류 메시지 제공
- 개발자 콘솔 로그 동시 기록

## 9. 개인정보 및 보안 관점 (현재 구현 기준)

### 9.1 개인정보 처리 특성

- 전화번호는 UI 안내상 비공개 목적 필드로 사용
- 실제 저장은 평문으로 DB에 저장됨
- 인증/권한 검증 로직은 프론트 코드에 포함되어 있지 않음

### 9.2 현재 구조의 보안 리스크

- Supabase URL/Anon Key가 클라이언트 코드에 하드코딩
- 중복 방지가 DB 제약이 아닌 클라이언트 검사에 의존
- 공개/비공개 접근 통제는 Supabase 정책 설정에 의존적

## 10. 비기능 특성

### 10.1 UI/UX

- 모바일 중심 화면 밀도와 큰 터치 타겟
- 카드형 인터페이스와 페이드/슬라이드 애니메이션
- 스크롤바 숨김 처리로 집중형 읽기 경험 제공

### 10.2 성능/확장성

- 기도실 목록을 전체 조회 후 클라이언트 순차 열람
- 페이지네이션/가상화 없음
- 데이터 증가 시 초기 로딩 부담이 커질 수 있음

## 11. 운영 체크리스트

- Supabase `prayers` 테이블 생성 및 컬럼 확인
- RLS/정책(읽기/쓰기) 요구사항에 맞게 설정
- 공개 데이터 노출 범위 정책 검토
- 배포 전 환경별 Supabase 키 관리 정책 점검

## 12. 확인된 구현 제약 및 개선 포인트

1. `기도하기` 백엔드 업데이트 실패 시 `localStorage` 값 롤백이 누락될 수 있다.
2. 중복 체크가 `name+phone+is_public` 기준이라, 공개/비공개가 다르면 별도 건으로 저장된다.
3. README는 현재 코드와 무관한 `GEMINI_API_KEY` 안내를 포함한다.
4. `PrayerRoom` props 중 `onReset`은 전달되지만 실제 사용되지 않는다.
5. 빌드 도구가 설치되지 않은 환경에서는 `tsc: command not found`로 빌드가 실패한다.

## 13. 기능 요약

이 시스템은 다음 세 축으로 구성된다.

- 입력 축: 기도 제목 작성, 중복 충돌 해결, 공개범위 선택
- 공유 축: 공개 기도 목록 최신순 열람과 순차 탐독
- 참여 축: `기도하기` 토글을 통한 참여 카운트 집계

현재 구현은 단순하고 직관적인 사용자 흐름에 강점이 있으며, 운영 단계에서는 DB 제약, 접근 정책, 오류 복구 정합성 보강이 핵심 개선 과제다.
